%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% This file is an extension library of PGF/Tikz.
%%%
%%% This library can be used to typeset pcb layouts.
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



% Copyright 2014 by Willem Van Onsem
%
% This file may be distributed and/or modified under the GNU General Public License.

\pgfkeys{/pgf/.cd,
	pcbdippins/.initial=7
}

\pgfdeclareshape{pcbvia} {

  \savedanchor\centerpoint{
    \pgf@x=.5\wd\pgfnodeparttextbox
    \pgf@y=.5\ht\pgfnodeparttextbox
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox
  } 
  \saveddimen\halfwidth{%
    \pgfmathsetlength{\pgf@xb}{\pgfkeysvalueof{/pgf/minimum width}}%  
    \pgf@x=0.5\pgf@xb
  }
  \saveddimen\halfheight{
    \pgfmathsetlength{\pgf@yb}{\pgfkeysvalueof{/pgf/minimum height}}%  
    \pgf@x=0.5\pgf@yb
  }
  \saveddimen\radius{%
    \pgfmathsetlength{\pgf@xb}{\pgfkeysvalueof{/pgf/minimum width}}%  
    \pgfmathsetlength{\pgf@yb}{\pgfkeysvalueof{/pgf/minimum height}}%  
    \pgf@x=.5\pgf@xb%
    \pgf@x=.5\pgf@yb%
  }

  \anchor{center}{\centerpoint}
  \anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}
  \anchor{base}{\centerpoint\pgf@y=0pt}
  \anchor{north}{\centerpoint\advance\pgf@y by\halfheight}
  \anchor{south}{\centerpoint\advance\pgf@y by-\halfheight}
  \anchor{west}{\centerpoint\advance\pgf@x by-\halfwidth}
  \anchor{east}{\centerpoint\advance\pgf@x by\halfwidth}
  \anchor{midwest}{\centerpoint\pgfutil@tempdima=\halfwidth\advance\pgf@x by-0.85\pgfutil@tempdima}

  \backgroundpath{
    \pgfseteorule
    \pgfutil@tempdima=\radius
    \pgfpathcircle{\centerpoint}{0.5\pgfutil@tempdima}
    \pgfpathcircle{\centerpoint}{\pgfutil@tempdima}
    \color{gray}
    \pgfusepath{fill}
  }
}

\pgfdeclareshape{pcbto92} {

  \savedanchor\centerpoint{
    \pgf@x=.5\wd\pgfnodeparttextbox
    \pgf@y=.5\ht\pgfnodeparttextbox
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox
  } 
  \saveddimen\halfwidth{%
    \pgfmathsetlength{\pgf@xb}{\pgfkeysvalueof{/pgf/minimum width}}%  
    \pgf@x=0.5\pgf@xb
  }
  \saveddimen\halfheight{
    \pgfmathsetlength{\pgf@yb}{\pgfkeysvalueof{/pgf/minimum height}}%  
    \pgf@x=0.5\pgf@yb
  }
  \saveddimen\radius{%
    \pgfmathsetlength{\pgf@xb}{\pgfkeysvalueof{/pgf/minimum width}}%  
    \pgfmathsetlength{\pgf@yb}{\pgfkeysvalueof{/pgf/minimum height}}%  
    \pgf@x=.5\pgf@xb%
    \pgf@x=.5\pgf@yb%
  }

  \anchor{center}{\centerpoint}
  \anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}
  \anchor{base}{\centerpoint\pgf@y=0pt}
  \anchor{north}{\centerpoint\advance\pgf@y by\halfheight}
  \anchor{south}{\centerpoint\advance\pgf@y by-\halfheight}
  \anchor{west}{\centerpoint\advance\pgf@x by-\halfwidth}
  \anchor{east}{\centerpoint\advance\pgf@x by\halfwidth}
  \anchor{pin1}{\centerpoint\advance\pgf@x by-\halfwidth}
  \anchor{pin2}{\centerpoint}
  \anchor{pin3}{\centerpoint\advance\pgf@x by\halfwidth}
  \anchor{midwest}{\centerpoint\pgfutil@tempdima=\halfwidth\advance\pgf@x by-0.85\pgfutil@tempdima}

  \backgroundpath{
    \pgfutil@tempdima=\radius
    \pgfutil@tempdimb=\halfwidth
    \pgfseteorule
    \pgfpathcircle{\centerpoint}{0.3\pgfutil@tempdima}
    \pgfpathcircle{\centerpoint}{0.15\pgfutil@tempdima}
    \centerpoint\advance\pgf@x by-\pgfutil@tempdimb
    \pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.3\pgfutil@tempdima}
    \centerpoint\advance\pgf@x by-\pgfutil@tempdimb
    \pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.15\pgfutil@tempdima}
    \centerpoint\advance\pgf@x by\pgfutil@tempdimb
    \pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.3\pgfutil@tempdima}
    \centerpoint\advance\pgf@x by\pgfutil@tempdimb
    \pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.15\pgfutil@tempdima}
    \color{gray}
    \pgfusepath{fill}
    \centerpoint
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    \advance\pgf@xa by0.707\pgfutil@tempdima
    \advance\pgf@ya by0.707\pgfutil@tempdima
    \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
    \pgfpatharc{45}{-225}{\pgfutil@tempdima and \pgfutil@tempdima}
    \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@ya}}
    \color{black}
    \pgfusepath{stroke}
  }
}

\pgfdeclareshape{pcbdip} {

  \savedanchor\centerpoint{
    \pgf@x=.5\wd\pgfnodeparttextbox
    \pgf@y=.5\ht\pgfnodeparttextbox
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox
  } 
  \saveddimen\halfwidth{%
    \pgfmathsetlength{\pgf@xb}{\pgfkeysvalueof{/pgf/minimum width}}%  
    \pgf@x=0.5\pgf@xb
  }
  \saveddimen\halfheight{
    \pgfmathsetlength{\pgf@yb}{\pgfkeysvalueof{/pgf/minimum height}}%  
    \pgf@x=0.5\pgf@yb
  }
  \saveddimen\radius{%
    \pgfmathsetlength{\pgf@xb}{\pgfkeysvalueof{/pgf/minimum width}}%  
    \pgfmathsetlength{\pgf@yb}{\pgfkeysvalueof{/pgf/minimum height}}%  
    \pgf@x=.5\pgf@xb%
    \pgf@x=.5\pgf@yb%
  }
  
  \savedmacro\numinputs{\let\numinputs4}

  \anchor{center}{\centerpoint}
  \anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}
  \anchor{base}{\centerpoint\pgf@y=0pt}
  \anchor{north}{\centerpoint\advance\pgf@y by\halfheight}
  \anchor{south}{\centerpoint\advance\pgf@y by-\halfheight}
  \anchor{west}{\centerpoint\advance\pgf@x by-\halfwidth}
  \anchor{east}{\centerpoint\advance\pgf@x by\halfwidth}
  \anchor{midwest}{\centerpoint\pgfutil@tempdima=\halfwidth\advance\pgf@x by-0.85\pgfutil@tempdima}

  \backgroundpath{
    \pgfutil@tempdima=\halfwidth
    \pgfseteorule
%     \pgfmathloop
%     \ifnum\pgfmathcounter>2
%     \else
      \pgfutil@tempdimb=\halfheight
      \advance\pgfutil@tempdimb by0.25\pgfutil@tempdima
      \pgfmathloop%
      \ifnum\pgfmathcounter>\numinputs
      \else
	\advance\pgfutil@tempdimb by-0.5\pgfutil@tempdima
	\centerpoint\advance\pgf@x by0.75\pgfutil@tempdima\advance\pgf@y by\pgfutil@tempdimb
	\pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.15\pgfutil@tempdima}
	\centerpoint\advance\pgf@x by0.75\pgfutil@tempdima\advance\pgf@y by\pgfutil@tempdimb
	\pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.075\pgfutil@tempdima}
	\centerpoint\advance\pgf@x by-0.75\pgfutil@tempdima\advance\pgf@y by\pgfutil@tempdimb
	\pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.15\pgfutil@tempdima}
	\centerpoint\advance\pgf@x by-0.75\pgfutil@tempdima\advance\pgf@y by\pgfutil@tempdimb
	\pgfpathcircle{\pgfpoint{\pgf@x}{\pgf@y}}{0.075\pgfutil@tempdima}
	\repeatpgfmathloop
      \fi
      \advance\pgfutil@tempdimb by-0.25\pgfutil@tempdima
      \centerpoint\advance\pgf@x by0.25\pgfutil@tempdima\advance\pgf@y by\halfheight
      \pgfpathmoveto{\pgfpoint{\pgf@x}{\pgf@y}}
      \centerpoint\advance\pgf@x by\halfwidth\advance\pgf@y by\halfheight
      \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
      \centerpoint\advance\pgf@x by\halfwidth\advance\pgf@y by\tempdimb
      \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
      \centerpoint\advance\pgf@x by-\halfwidth\advance\pgf@y by\tempdimb
      \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
      \centerpoint\advance\pgf@x by-\halfwidth\advance\pgf@y by\halfheight
      \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
      \centerpoint\advance\pgf@x by-0.25\pgfutil@tempdima\advance\pgf@y by\halfheight
      \pgfpathlineto{\pgfpoint{\pgf@x}{\pgf@y}}
      \pgfpatharc{-180}{0}{0.25\pgfutil@tempdima and 0.25\pgfutil@tempdima}
      \color{black}
      \pgfusepath{stroke}
    \color{gray}
    \pgfusepath{fill}
  }
}